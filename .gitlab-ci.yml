image: docker:git

services:
  - docker:dind

stages:
  - lint
  - build
  - deploy

before_script:
  - if [ -z "${REGISTRY_USER_NAME}" ]; then REGISTRY_USER_NAME=gitlab-ci-token; fi
  - if [ -z "${REGISTRY_SECRET}" ]; then REGISTRY_SECRET=${CI_JOB_TOKEN}; fi
  - docker login -u ${REGISTRY_USER_NAME} -p ${REGISTRY_SECRET} ${CI_REGISTRY}

lint-nuxt:
  stage: lint
  image: node:20.11.0
  before_script:
    - cd frontend
    - npm install
  script:
    - npm run lint .
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
      changes:
      - frontend/**/*

build-nuxt:
  stage: build
  variables:
    IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}/nuxt:master
  script:
    - docker build -f ./.deploy/nuxt/Dockerfile -t ${IMAGE} ./
    - docker push ${IMAGE}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
      - frontend/**/*

build-backend:
  stage: build
  variables:
    IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}/backend:master
  script:
    - docker build -f ./.deploy/backend/Dockerfile -t ${IMAGE} ./
    - docker push ${IMAGE}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
      - backend/**/*

deploy:
  stage: deploy
  image: alpine:latest
  environment:
    name: prod
    url: https://liquiswiss.devs-group.ch/
  before_script:
    - apk add curl
  script:
    - sh ./.deploy/deploy.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
